{% extends "core/base.html" %}

{% block content %}
<div class="container-fluid p-4">
    <h1 class="mb-4">
        Results for 
        {% if campaign %}{{ campaign.name }}{% else %}<em>No campaign selected</em>{% endif %}
    </h1>

    <form method="get" action="{% url 'campaign_results' %}" class="mb-3">
        <label for="campaignSelect">Select Campaign:</label>
        <select name="campaign_id" id="campaignSelect" class="form-select" onchange="this.form.submit()">
            {% for c in active_campaigns %}
                <option value="{{ c.id }}" {% if c.id == campaign.id %}selected{% endif %}>{{ c.name }}</option>
            {% endfor %}
        </select>
    </form>

    <div class="mb-3">
        <a href="{% url 'campaign_list' %}" class="btn btn-secondary">Back</a>
        <a href="{% url 'campaign_results' %}?campaign_id={{ campaign.id }}" class="btn btn-primary">Refresh</a>
    </div>

    <!-- Summary Cards Section -->
    <div class="row text-center mb-5">
        <div class="col-md-2">
            <div class="card">
                <div class="card-body">
                    <h6>Email Sent</h6>
                    <h3>{{ results.total }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card">
                <div class="card-body">
                    <h6>Email Opened</h6>
                    <h3>{{ results.opens }}</h3>
                    {% if external_stats.first_open_time and external_stats.last_open_time %}
                        <small class="text-muted d-block mt-2">
                            First: {{ external_stats.first_open_time|date:"Y-m-d h:i:s" }}<br>
                            Last: {{ external_stats.last_open_time|date:"Y-m-d h:i:s" }}
                        </small>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card">
                <div class="card-body">
                    <h6>Clicked Link</h6>
                    <h3>{{ results.clicks }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card">
                <div class="card-body">
                    <h6>Submitted Data</h6>
                    <h3>{{ results.submissions }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table Section (Dynamically populated) -->
    <div id="data-table-section" class="mt-4">
        <h3>Fetched Data</h3>
        <table class="table table-bordered table-striped" id="data-table">
            <thead>
                <tr>
                    <th>Campaign ID</th>
                    <th>Token ID</th>
                    <th>Email</th>
                    <th>Password</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be populated here via AJAX -->
            </tbody>
        </table>
    </div>

</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Extract campaign_id and token_id from the URL query parameters
        const urlParams = new URLSearchParams(window.location.search);
        const campaignId = urlParams.get('campaign_id');
        const tokenId = urlParams.get('token');

        if (campaignId && tokenId) {
            // Construct the URL to fetch data from your backend (replace with actual URL)
            const dataUrl = `http://127.0.0.1:8000/user/${campaignId}/${tokenId}`;
            
            // Fetch data from your backend using the constructed URL
            fetch(dataUrl)
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.querySelector("#data-table tbody");

                    // Check if data is available
                    if (data && data.email && data.password) {
                        // Create table row dynamically
                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td>${campaignId}</td>
                            <td>${tokenId}</td>
                            <td>${data.email}</td>
                            <td>${data.password}</td>
                        `;
                        tableBody.appendChild(row);
                    } else {
                        // If no data is available
                        const row = document.createElement("tr");
                        row.innerHTML = "<td colspan='4' class='text-center'>No data available</td>";
                        tableBody.appendChild(row);
                    }
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                    const tableBody = document.querySelector("#data-table tbody");
                    const row = document.createElement("tr");
                    row.innerHTML = "<td colspan='4' class='text-center'>Error fetching data</td>";
                    tableBody.appendChild(row);
                });
        } else {
            console.log("Missing campaign_id or token in the URL.");
        }
    });
</script>

{% endblock %}
