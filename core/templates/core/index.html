{% extends "core/base.html" %}

{% block content %}
<div class="container-fluid p-4">
    <h1 class="mb-4">
        Results for 
        {% if campaign %}{{ campaign.name }}{% else %}<em>No campaign selected</em>{% endif %}
    </h1>

    <form method="get" action="{% url 'campaign_results' %}" class="mb-3">
        <label for="campaignSelect">Select Campaign:</label>
        <select name="campaign_id" id="campaignSelect" class="form-select" onchange="this.form.submit()">
            {% for c in active_campaigns %}
                <option value="{{ c.id }}" {% if c.id == campaign.id %}selected{% endif %}>{{ c.name }}</option>
            {% endfor %}
        </select>
    </form>

    <div class="mb-3">
        <a href="{% url 'campaign_list' %}" class="btn btn-secondary">Back</a>
        <a href="{% url 'campaign_results' %}?campaign_id={{ campaign.id }}" class="btn btn-primary" id="refreshBtn">Refresh</a>
    </div>

    <!-- Summary Cards Section -->
    <div class="row text-center mb-5">
        <div class="col-md-2">
            <div class="card">
                <div class="card-body">
                    <h6>Email Sent</h6>
                    <h3>{{ results.total }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card">
                <div class="card-body">
                    <h6>Email Opened</h6>
                    <h3>{{ results.opens }}</h3>
                    {% if external_stats.first_open_time and external_stats.last_open_time %}
                        <small class="text-muted d-block mt-2">
                            First: {{ external_stats.first_open_time|date:"Y-m-d h:i:s" }}<br>
                            Last: {{ external_stats.last_open_time|date:"Y-m-d h:i:s" }}
                        </small>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card">
                <div class="card-body">
                    <h6>Clicked Link</h6>
                    <h3>{{ results.clicks }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card">
                <div class="card-body">
                    <h6>Submitted Data</h6>
                    <!-- Replace the "Submitted Data" block with the button -->
                    <button class="btn btn-primary" id="fetchSubmittedDataBtn">Fetch Submitted Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table Section (Dynamically populated) -->
    <div id="data-table-section" class="mt-4">
        <h3>Fetched Data</h3>
        <table class="table table-bordered table-striped" id="data-table">
            <thead>
                <tr>
                    <th>Campaign ID</th>
                    <th>Token ID</th>
                    <th>Email</th>
                    <th>Password</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be populated here via AJAX -->
            </tbody>
        </table>
    </div>

</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const fetchSubmittedDataBtn = document.getElementById("fetchSubmittedDataBtn");
        const tableBody = document.querySelector("#data-table tbody");
        const campaignSelect = document.getElementById("campaignSelect");  // Dropdown for selecting campaign

        // Fetch and display data when the button is clicked
        fetchSubmittedDataBtn.addEventListener('click', function () {
            let campaignId = new URLSearchParams(window.location.search).get('campaign_id'); // Get campaign_id from URL query parameter

            // If the campaign_id is not found in the URL, take it from the dropdown
            if (!campaignId && campaignSelect) {
                campaignId = campaignSelect.value;
            }

            if (campaignId) {  // Ensure campaignId is not null or undefined
                // Construct the URL to fetch data from your backend
                const dataUrl = `http://127.0.0.1:8003/user/${campaignId}`;
                
                // Fetch data from the backend
                fetch(dataUrl)
                    .then(response => response.json())
                    .then(data => {
                        // Clear any existing table rows before adding new data
                        tableBody.innerHTML = '';

                        // Check if data is available
                        if (data.users && data.users.length > 0) {
                            // Loop through each user and create table rows dynamically
                            data.users.forEach(user => {
                                const row = document.createElement("tr");
                                row.innerHTML = `
                                    <td>${user.campaign_id}</td>
                                    <td>${user.token}</td>
                                    <td>${user.email}</td>
                                    <td>${user.password}</td>
                                `;
                                tableBody.appendChild(row);
                            });
                        } else {
                            // If no data is available
                            const row = document.createElement("tr");
                            row.innerHTML = "<td colspan='4' class='text-center'>No records found for this campaign</td>";
                            tableBody.appendChild(row);
                        }
                    })
                    .catch(error => {
                        console.error("Error fetching data:", error);
                        const row = document.createElement("tr");
                        row.innerHTML = "<td colspan='4' class='text-center'>Error fetching data</td>";
                        tableBody.appendChild(row);
                    });
            } else {
                console.log("Missing campaign_id in the URL or dropdown.");
            }
        });
    });
</script>


{% endblock %}
